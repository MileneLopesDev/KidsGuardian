<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="src/styles/styles.css">
  <link rel="icon" type="image/png" href="src/images/icon.png">
  <title>KG - Editar Perfil</title>
</head>

<body>
  <header>
    <nav id="navbar">
      <div class="logo"><img src="src/images/logo.png"></div>
      <ul id="nav_list">
        <li class="nav-item active"><a href="index.html">Inicio</a></li>
        <li class="nav-item"><a href="explorar.html">Explore</a></li>
        <li class="nav-item"><a href="login.html"></a></li>
      </ul>
      <button id="mobile_btn"><i class="fa-solid fa-bars"></i></button>
    </nav>
    <div id="mobile_menu">
      <ul id="mobile_nav_list">
        <li class="nav-item">
          <a href="index.html">Inicio</a>
        </li>
        <li class="nav-item">
          <a href="explorar.html">Explorar</a>
        </li>
        <li class="nav-item">
          <a href="login.html">Login</a>
        </li>
      </ul>


    </div>
  </header>

  <div class="form-container">
    <h2>Editar Perfil</h2>
    <form id="editProfileForm">
      <label for="email">Email:</label>
      <input type="email" id="email" disabled>
      <label for="name">Nome:</label>
      <input type="text" id="displayName" required>
      <label for="categoria">Você é:</label>
      <select id="categoria">
        <option value="0">Apenas interessado pelo assunto</option>
        <option value="1">Responsável</option>
        <option value="2">Educador</option>
      </select>
      <button class="btn-default" type="submit">Salvar Alterações</button>
    </form>
    <div id="updateError"></div>
  </div>

  <footer>
    <img src="src/images/wave.svg">
    <div id="footer_items">
      <span id="copyright">&copy 2024 Milene Lopes</span>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="src/javascript/firebase-config.js"></script>
  <script src="src/javascript/script.js"></script>
  <script>
    // Função para carregar dados do usuário
    function carregarDadosUsuario() {
      const user = firebase.auth().currentUser;
      if (user) {
        // Preenche os campos com os dados do usuário
        document.getElementById('email').value = user.email;
        document.getElementById('displayName').value = user.displayName || '';
        // Caso a categoria esteja armazenada no Firestore, buscar e preencher
        firebase.firestore().collection('users').doc(user.uid).get().then((doc) => {
          if (doc.exists && doc.data().categoria) {
            document.getElementById('categoria').value = doc.data().categoria;
          }
        });
      } else {
        // Redireciona para login se o usuário não estiver autenticado
        alert('Você precisa estar logado para acessar esta página.');
        window.location.href = 'login.html';
      }
    }

    // Atualizar dados do perfil
    document.getElementById('editProfileForm').addEventListener('submit', function (event) {
      event.preventDefault();

      const user = firebase.auth().currentUser;
      const displayName = document.getElementById('displayName').value;
      const categoria = document.getElementById('categoria').value;
      const errorDiv = document.getElementById('updateError');
      errorDiv.textContent = ''; // Limpa mensagens de erro

      if (user) {
        // Atualiza o perfil do usuário
        user.updateProfile({ displayName }).then(() => {
          // Salva a categoria no Firestore
          return firebase.firestore().collection('users').doc(user.uid).set({ categoria }, { merge: true });
        }).then(() => {
          alert('Perfil atualizado com sucesso!');
          window.location.href = 'index.html'; // Redireciona para a página inicial
        }).catch((error) => {
          errorDiv.textContent = 'Erro ao atualizar perfil: ' + error.message;
        });
      } else {
        errorDiv.textContent = 'Erro: Usuário não autenticado.';
      }
    });

    // Carregar dados ao abrir a página
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        carregarDadosUsuario();
      }
    });
  </script>
</body>

</html>